@using System.Threading.Tasks
@using Shared.Models
@using Microsoft.AspNetCore.Components
@using Shared.Services.Interfaces
@using System.Text.RegularExpressions
@inject ILocalAuthorityApiService AuthorityService
@inject IJSRuntime JS
@rendermode InteractiveWebAssembly

<div class="toolbox">
    <button id="toggleLayer" @onclick="DebouncedToggleLayer">Toggle Layer</button>

    <div class="search-box">
        <input type="text" @bind="searchQuery" @oninput="OnSearchInput" placeholder="Search Areas..." />

        <button id="search" @onclick="DebouncedSearchClick" disabled="@(!IsValidQuery)">Search</button>

        @if (!IsValidQuery && searchQuery.Length > 0)
        {
            <p class="validation-message">Only letters and spaces are allowed. Numbers and special characters are not valid.</p>
        }
    </div>

    @if (filteredAreas?.Count > 0)
    {
        <ul class="suggestions">
            @foreach (var area in filteredAreas)
            {
                <li @onclick="() => SelectArea(area)">@area</li>
            }
        </ul>
    }
</div>

@code {
    private string searchQuery = string.Empty;
    private List<string> areas = new List<string> { };
    private List<string> filteredAreas;
    private static readonly int debounceDelay = 500; // 500ms delay for debouncing
    private System.Threading.CancellationTokenSource debounceSearchCts;
    private bool IsValidQuery =>
    !string.IsNullOrWhiteSpace(searchQuery) &&
    Regex.IsMatch(searchQuery, @"^[A-Za-z\s]+$");

    private async Task DebouncedToggleLayer()
    {
        if (debounceSearchCts != null)
        {
            debounceSearchCts.Cancel();
        }

        debounceSearchCts = new System.Threading.CancellationTokenSource();

        await Task.Delay(debounceDelay);
        if (!debounceSearchCts.Token.IsCancellationRequested)
        {
            ToggleLayer(); // Only toggle visibility if the delay has passed
        }
    }

    private async Task ToggleLayer()
    {
        await JS.InvokeVoidAsync("azureMaps.clearMap");
    }

    private async Task DebouncedSearchClick()
    {
        if (!IsValidQuery) return;

        debounceSearchCts?.Cancel();
        debounceSearchCts = new System.Threading.CancellationTokenSource();

        await Task.Delay(debounceDelay);
        if (!debounceSearchCts.Token.IsCancellationRequested)
        {
            FilterAreas(); // Trigger the search if the delay passes
        }
    }

    private async Task FilterAreas()
    {
        if (!IsValidQuery) return;
        filteredAreas = new List<string>();
        var localAuthorityGeo = await AuthorityService.BboxByNameAsync(searchQuery);
        await JS.InvokeVoidAsync("azureMaps.setFilter", searchQuery, localAuthorityGeo);
    }

    private async void OnSearchInput(ChangeEventArgs e)
    {
        searchQuery = e.Value.ToString();

        // Debounce input events, but don't trigger the search until the user stops typing
        DebouncedSearchInput();
    }

    private async void DebouncedSearchInput()
    {
        if (!IsValidQuery) return;

        debounceSearchCts?.Cancel();
        debounceSearchCts = new System.Threading.CancellationTokenSource();

        await Task.Delay(debounceDelay);
        if (!debounceSearchCts.Token.IsCancellationRequested)
        {
            FillIntellisense();
        }
    }

    private async Task FillIntellisense()
    {
        filteredAreas = await AuthorityService.FilterByNameAsync(searchQuery);
    }

    private void SelectArea(string area)
    {
        searchQuery = area;
        filteredAreas = new List<string>(); // Clear suggested districts
    }

}
