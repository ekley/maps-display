@using System.Threading.Tasks
@using MapsDisplay.Client.Services
@using Shared.Models
@using Microsoft.AspNetCore.Components
@inject LocalAuthorityApiService AuthorityService
@inject IJSRuntime JS
@rendermode InteractiveWebAssembly

<div class="toolbox">
    <button @onclick="DebouncedToggleLayer">Toggle Layer</button>

    <div class="search-box">
        <input type="text" @bind="searchQuery" @oninput="OnSearchInput" placeholder="Search Areas..." />

        <button @onclick="DebouncedSearchClick">Search</button>
    </div>

    @if (filteredAreas?.Count > 0)
    {
        <ul class="suggestions">
            @foreach (var area in filteredAreas)
            {
                <li @onclick="() => SelectArea(area)">@area</li>
            }
        </ul>
    }
</div>

@code {
    private string searchQuery = string.Empty;
    private List<string> areas = new List<string> { };
    private List<string> filteredAreas;
    private static readonly int debounceDelay = 500; // 500ms delay for debouncing
    private System.Threading.CancellationTokenSource debounceSearchCts;

    private async Task DebouncedToggleLayer()
    {
        if (debounceSearchCts != null)
        {
            debounceSearchCts.Cancel();
        }

        debounceSearchCts = new System.Threading.CancellationTokenSource();

        await Task.Delay(debounceDelay);
        if (!debounceSearchCts.Token.IsCancellationRequested)
        {
            ToggleLayer(); // Only toggle visibility if the delay has passed
        }
    }

    private async Task ToggleLayer()
    {
        await JS.InvokeVoidAsync("azureMaps.clearMap");
    }

    private async Task DebouncedSearchClick()
    {
        if (debounceSearchCts != null)
        {
            debounceSearchCts.Cancel();
        }

        debounceSearchCts = new System.Threading.CancellationTokenSource();

        await Task.Delay(debounceDelay);
        if (!debounceSearchCts.Token.IsCancellationRequested)
        {
            FilterAreas(); // Trigger the search if the delay passes
        }
    }

    private async Task FilterAreas()
    {
        var localAuthorityGeo = await AuthorityService.BboxByNameAsync(searchQuery);
        await JS.InvokeVoidAsync("azureMaps.setFilter", searchQuery, localAuthorityGeo);
    }

    private async void OnSearchInput(ChangeEventArgs e)
    {
        searchQuery = e.Value.ToString();

        // Debounce input events, but don't trigger the search until the user stops typing
        DebouncedSearchInput();
    }

    private async void DebouncedSearchInput()
    {
        if (debounceSearchCts != null)
        {
            debounceSearchCts.Cancel();
        }

        debounceSearchCts = new System.Threading.CancellationTokenSource();

        await Task.Delay(debounceDelay);
        if (!debounceSearchCts.Token.IsCancellationRequested)
        {
            FillIntellisense();
        }
    }

    private async Task FillIntellisense()
    {
        filteredAreas = await AuthorityService.FilterByNameAsync(searchQuery);
    }

    private void SelectArea(string area)
    {
        searchQuery = area;
        filteredAreas = new List<string>(); // Clear suggested districts
    }

}

<style>
    .toolbox {
        width: 300px;
        padding: 10px;
        background-color: #f0f0f0;
        border: 1px solid #ccc;
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10;
    }

    .search-box {
        margin-top: 10px;
    }

    .search-box input {
        width: 80%;
        padding: 5px;
    }

    .search-box button {
        padding: 5px;
        margin-left: 10px;
    }

    .suggestions {
        list-style-type: none;
        padding: 0;
        margin-top: 5px;
        background-color: white;
        border: 1px solid #ccc;
        max-height: 150px;
        overflow-y: auto;
    }

    .suggestions li {
        padding: 5px;
        cursor: pointer;
    }

    .suggestions li:hover {
        background-color: #e0e0e0;
    }
</style>