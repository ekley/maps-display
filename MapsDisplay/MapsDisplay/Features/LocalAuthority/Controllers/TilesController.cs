using Microsoft.AspNetCore.Mvc;
using Microsoft.Data.Sqlite;
using Shared.Utilities;

namespace MapsDisplay.Features.LocalAuthority.Controllers
{
    [Route("api/tiles")]
    [ApiController]
    public class TilesController : ControllerBase
    {
        // get local_authorities.mbtiles file directory from Features/Data/Datasets folder 
        // (the file is generated by Tippecanoe [for more info look at INSTRUCTION_TO_GENERATE_MBTILES.MD])
        const string MBTILE_FILE_NAME = "local_authorities.mbtiles";
        private readonly string defaultMbtilesPath = Path.Combine(Directory.GetCurrentDirectory(), "Features", "LocalAuthority", "Data", "Datasets", MBTILE_FILE_NAME);
        private readonly string _mbtilesPath;
        private readonly ILogger<TilesController> _logger;

        public TilesController(ILogger<TilesController> logger, string? mbtilesPath = null)
        {
            _mbtilesPath = mbtilesPath ?? defaultMbtilesPath;
            _logger = logger ?? throw new ArgumentNullException(nameof(logger));
        }

        private Result<byte[]> GetTileData(int z, int x, int y)
        {
            try
            {
                SQLitePCL.Batteries_V2.Init();

                using var connection = new SqliteConnection($"Data Source={_mbtilesPath};");
                connection.Open();

                var command = connection.CreateCommand();
                command.CommandText = "SELECT tile_data FROM tiles WHERE zoom_level = @z AND tile_column = @x AND tile_row = @y";
                command.Parameters.AddWithValue("@z", z);
                command.Parameters.AddWithValue("@x", x);
                command.Parameters.AddWithValue("@y", FlipY(z, y));

                var tileData = command.ExecuteScalar() as byte[];

                if (tileData == null)
                {
                    return Result<byte[]>.Failure("Tile data not found.");
                }

                return Result<byte[]>.Success(tileData);
            }
            catch (SqliteException ex)
            {
                _logger.LogError(ex, "Database error occurred while retrieving tile: z={Z}, x={X}, y={Y}", z, x, y);
                return Result<byte[]>.Failure("Database error while retrieving tile.");
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Unexpected error occurred while retrieving tile: z={Z}, x={X}, y={Y}", z, x, y);
                return Result<byte[]>.Failure("Unexpected error while retrieving tile.");
            }
        }

        /// <summary>
        /// Retrieves a tile by its zoom level, x, and y coordinates.
        /// </summary>
        /// <param name="z">Zoom level of the tile.</param>
        /// <param name="x">X coordinate of the tile.</param>
        /// <param name="y">Y coordinate of the tile.</param>
        /// <returns>The tile data in protobuf format.</returns>
        [HttpGet("{z:int}/{x:int}/{y:int}.pbf")]
        public IActionResult GetTile(int z, int x, int y)
        {
            if (z < 0 || x < 0 || y < 0)
            {
                _logger.LogWarning("Invalid tile coordinates: z={Z}, x={X}, y={Y}", z, x, y);
                return BadRequest("Tile coordinates cannot be negative.");
            }

            if (!System.IO.File.Exists(_mbtilesPath))
            {
                _logger.LogError("MBTiles file not found at path: {MbtilesPath}", _mbtilesPath);
                return NotFound("MBTiles file not found.");
            }

            var result = GetTileData(z, x, y);

            if (!result.IsSuccess)
            {
                _logger.LogError("Error retrieving tile: {Error}", result.Error);
                return StatusCode(500, result.Error);
            }

            if (result.Value == null)
            {
                return NoContent();
            }

            return new FileContentResult(result.Value, "application/x-protobuf");
        }

        private static int FlipY(int zoom, int y) => (1 << zoom) - 1 - y;
    }

}
